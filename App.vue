<script>
import Navbar from "./src/components/Navbar.vue"
import Tabs from "./src/components/Tabs.vue"
import Textareas from "./src/components/Textareas.vue"
import Buttons from "./src/components/Buttons.vue"
import { h } from "vue"
import { ElMessageBox } from "element-plus"
export default {
  name: "Text Editor Online",
  components: {
    Navbar,
    Tabs,
    Textareas,
    Buttons
  },
  metaInfo: {
    title: "Text Editor Online",
  },
  methods: {
    save() {
      let titlevalue = document.getElementById("title").value
      let textvalue = document.getElementById("text").value
      let file = new File([textvalue], `${titlevalue}.txt`, {
        type: "text/plain"
      })
      let titlebox = document.getElementById("title")
      if (titlevalue.length == 0 && textvalue.length == 0) {
        ElMessageBox.alert("I need a title and a content to be saved", "Error", { draggable: true, type: "error", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
        titlebox.focus()
        return
      }
      else if (titlevalue.length == 0) {
        ElMessageBox.alert("I need a title to be saved", "Error", { draggable: true, type: "error", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
        titlebox.focus()
        return
      }
      else if (textvalue.length == 0) {
        ElMessageBox.alert("I need a content to be saved", "Error", { draggable: true, type: "error", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
        titlebox.focus()
        return
      }
      ElMessageBox.confirm("Are you sure you want to save it?", "Warning", { draggable: true, type: "warning", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
        .then(() => {
          let link = document.createElement("a")
          let url = URL.createObjectURL(file)
          link.href = url
          link.download = file.name
          link.click()
          file.save
          titlebox.focus()
        })
        .catch(() => {
          titlebox.focus()
        })
    },
    loadFile() {
      let input = document.createElement("input")
      input.type = "file"
      input.accept = ".txt"
      input.onchange = () => {
        let file = input.files[0]
        document.getElementById("title").focus()
        if (file.type != "text/plain") {
          return ElMessageBox.alert("Only txt files are supported", "Error", { draggable: true, type: "error", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
        }
        document.getElementById("title").value = file.name.replace(".txt", "")
        document.getElementById("titlechar").innerHTML = file.name.replace(".txt", "").length
        let content = new FileReader()
        content.onload = () => {
          document.getElementById("text").value = content.result
          document.getElementById("textchar").innerHTML = content.result.length
        }
        content.readAsText(file)
      }
      input.click()
    },
    share() {
      let titlevalue = document.getElementById("title").value
      let textvalue = document.getElementById("text").value
      let url = window.location.hostname
      let urlbeginning = window.location.hostname.includes("localhost") || window.location.hostname.includes("127.0.0.1") ? `http://` : `https://`
      if (titlevalue.length == 0 && textvalue.length == 0) {
        let copy = `${urlbeginning}${url}/`
        navigator.clipboard.writeText(copy)
        ElMessageBox.alert("Successfully copied link, you can now share it with your friends!", "Success", { draggable: true, type: "success", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
        document.getElementById("title").focus()
      }
      else if (titlevalue.length == 0) {
        let copy = `${urlbeginning}${url}?content=${textvalue}`
        navigator.clipboard.writeText(copy)
        ElMessageBox.alert("Successfully copied link, you can now share it with your friends!", "Success", { draggable: true, type: "success", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
        document.getElementById("title").focus()
      }
      else if (textvalue.length == 0) {
        let copy = `${urlbeginning}${url}?title=${titlevalue}`
        navigator.clipboard.writeText(copy)
        ElMessageBox.alert("Successfully copied link, you can now share it with your friends!", "Success", { draggable: true, type: "success", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
        document.getElementById("title").focus()
      }
      else {
        if (titlevalue == textvalue) {
          let copy = `${urlbeginning}${url}?title=${titlevalue}&content=$title`
          navigator.clipboard.writeText(copy)
          ElMessageBox.alert("Successfully copied link, you can now share it with your friends!", "Success", { draggable: true, type: "success", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
          document.getElementById("title").focus()
        }
        else {
          let copy = `${urlbeginning}${url}?title=${titlevalue}&content=${textvalue}`
          navigator.clipboard.writeText(copy)
          ElMessageBox.alert("Successfully copied link, you can now share it with your friends!", "Success", { draggable: true, type: "success", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
          document.getElementById("title").focus()
        }
      }
    },
    onContextMenu(e) {
      e.preventDefault()
      this.$contextmenu({
        x: e.x,
        y: e.y,
        items: [
          {
            label: "Save",
            icon: h("img", {
              src: "https://raw.githubusercontent.com/element-plus/element-plus-icons/971f292c776717e6c682f3f806a4a85d97f709a1/packages/svg/download.svg",
              style: {
                width: "20px",
                height: "20px"
              }
            }),
            onClick: () => {
              this.save()
            }
          },
          {
            id: "File",
            label: "Load",
            icon: h("img", {
              src: "https://raw.githubusercontent.com/element-plus/element-plus-icons/971f292c776717e6c682f3f806a4a85d97f709a1/packages/svg/upload.svg",
              style: {
                width: "20px",
                height: "20px"
              }
            }),
            onClick: () => {
              let url = new URLSearchParams(window.location.search)
              if (url.has("title") || url.has("content")) {
                return ElMessageBox.alert("You can't use this because of titleparam or textparam", "Error", { draggable: true, type: "error", customStyle: { fontFamily: "'Martian Mono', monospace" }, distinguishCancelAndClose: true })
              }
              this.loadFile()
            }
          },
          {
            label: "Share",
            icon: h("img", {
              src: "https://raw.githubusercontent.com/element-plus/element-plus-icons/971f292c776717e6c682f3f806a4a85d97f709a1/packages/svg/share.svg",
              style: {
                width: "20px",
                height: "20px"
              }
            }),
            onClick: () => {
              this.share()
            }
          },
        ]
      })
    }
  }
}
</script>
<script setup>
import onload from "./src/scripts/onload.js"
import keys from "./src/scripts/keys.js"
import tabs from "./src/scripts/tabs.js"
import { onMounted } from "vue"
onMounted(() => {
  onload(),
    keys(),
    tabs()
})
</script>
<template>
  <div id="app" @contextmenu="onContextMenu($event)">
    <Navbar />
    <Tabs />
    <Textareas />
    <Buttons />
  </div>
</template>